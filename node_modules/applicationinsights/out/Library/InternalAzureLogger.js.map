{"version":3,"file":"InternalAzureLogger.js","sourceRoot":"","sources":["../../Library/InternalAzureLogger.ts"],"names":[],"mappings":"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","sourcesContent":["import fs = require(\"fs\");\r\nimport os = require(\"os\");\r\nimport path = require(\"path\");\r\nimport FileSystemHelper = require(\"./FileSystemHelper\");\r\n\r\n\r\nclass InternalAzureLogger {\r\n\r\n    private static _instance: InternalAzureLogger;\r\n    public maxHistory: number;\r\n    public maxSizeBytes: number;\r\n\r\n    private TAG = \"Logger\";\r\n    private _cleanupTimeOut = 60 * 30 * 1000; // 30 minutes;\r\n    private static _fileCleanupTimer: NodeJS.Timer = null;\r\n    private _tempDir: string;\r\n    public _logFileName: string;\r\n    private _fileFullPath: string;\r\n    private _backUpNameFormat: string;\r\n    private _logToFile = false;\r\n    private _logToConsole = true;\r\n\r\n\r\n    constructor() {\r\n        let logDestination = process.env.APPLICATIONINSIGHTS_LOG_DESTINATION; // destination can be one of file, console or file+console\r\n        if (logDestination == \"file+console\") {\r\n            this._logToFile = true;\r\n        }\r\n        if (logDestination == \"file\") {\r\n            this._logToFile = true;\r\n            this._logToConsole = false;\r\n        }\r\n        this.maxSizeBytes = 50000;\r\n        this.maxHistory = 1;\r\n        this._logFileName = \"applicationinsights.log\";\r\n\r\n        // If custom path not provided use temp folder, /tmp for *nix and USERDIR/AppData/Local/Temp for Windows\r\n        let logFilePath = process.env.APPLICATIONINSIGHTS_LOGDIR;\r\n        if (!logFilePath) {\r\n            this._tempDir = path.join(os.tmpdir(), \"appInsights-node\");\r\n        }\r\n        else {\r\n            if (path.isAbsolute(logFilePath)) {\r\n                this._tempDir = logFilePath;\r\n            }\r\n            else {\r\n                this._tempDir = path.join(process.cwd(), logFilePath);\r\n            }\r\n        }\r\n        this._fileFullPath = path.join(this._tempDir, this._logFileName);\r\n        this._backUpNameFormat = \".\" + this._logFileName; // {currentime}.applicationinsights.log\r\n\r\n        if (this._logToFile) {\r\n            if (!InternalAzureLogger._fileCleanupTimer) {\r\n                InternalAzureLogger._fileCleanupTimer = setInterval(() => { this._fileCleanupTask(); }, this._cleanupTimeOut);\r\n                InternalAzureLogger._fileCleanupTimer.unref();\r\n            }\r\n        }\r\n    }\r\n\r\n    public info(message?: any, ...optionalParams: any[]) {\r\n        let args = message ? [message, ...optionalParams] : optionalParams;\r\n        if (this._logToFile) {\r\n            this._storeToDisk(args);\r\n        }\r\n        if (this._logToConsole) {\r\n            console.info(...args);\r\n        }\r\n    }\r\n\r\n    public warning(message?: any, ...optionalParams: any[]) {\r\n        let args = message ? [message, ...optionalParams] : optionalParams;\r\n        if (this._logToFile) {\r\n            this._storeToDisk(args);\r\n        }\r\n        if (this._logToConsole) {\r\n            console.warn(...args);\r\n        }\r\n    }\r\n\r\n    static getInstance() {\r\n        if (!InternalAzureLogger._instance) {\r\n            InternalAzureLogger._instance = new InternalAzureLogger();\r\n        }\r\n        return InternalAzureLogger._instance;\r\n    }\r\n\r\n    private async _storeToDisk(args: any): Promise<void> {\r\n        let data = args + \"\\r\\n\";\r\n\r\n        try {\r\n            await FileSystemHelper.confirmDirExists(this._tempDir);\r\n        }\r\n        catch (err) {\r\n            console.log(this.TAG, \"Failed to create directory for log file: \" + (err && err.message));\r\n            return;\r\n        }\r\n        try {\r\n            await FileSystemHelper.accessAsync(this._fileFullPath, fs.constants.F_OK);\r\n        }\r\n        catch (err) {\r\n            // No file create one  \r\n            await FileSystemHelper.appendFileAsync(this._fileFullPath, data).catch((appendError) => {\r\n                console.log(this.TAG, \"Failed to put log into file: \" + (appendError && appendError.message));\r\n            });\r\n            return;\r\n        }\r\n        try {\r\n            // Check size\r\n            let size = await FileSystemHelper.getShallowFileSize(this._fileFullPath);\r\n            if (size > this.maxSizeBytes) {\r\n                await this._createBackupFile(data);\r\n            }\r\n            else {\r\n                await FileSystemHelper.appendFileAsync(this._fileFullPath, data);\r\n            }\r\n        }\r\n        catch (err) {\r\n            console.log(this.TAG, \"Failed to create backup file: \" + (err && err.message));\r\n        }\r\n    }\r\n\r\n    private async _createBackupFile(data: string): Promise<void> {\r\n        try {\r\n            let buffer = await FileSystemHelper.readFileAsync(this._fileFullPath);\r\n            let backupPath = path.join(this._tempDir, new Date().getTime() + \".\" + this._logFileName);\r\n            await FileSystemHelper.writeFileAsync(backupPath, buffer);\r\n        }\r\n        catch (err) {\r\n            console.log(`Failed to generate backup log file`, err);\r\n        }\r\n        finally {\r\n            // Store logs\r\n            FileSystemHelper.writeFileAsync(this._fileFullPath, data);\r\n        }\r\n    }\r\n\r\n    private async _fileCleanupTask(): Promise<void> {\r\n        try {\r\n            let files = await FileSystemHelper.readdirAsync(this._tempDir);\r\n            // Filter only backup files\r\n            files = files.filter(f => path.basename(f).indexOf(this._backUpNameFormat) > -1);\r\n            // Sort by creation date\r\n            files.sort((a: string, b: String) => {\r\n                // Check expiration\r\n                let aCreationDate: Date = new Date(parseInt(a.split(this._backUpNameFormat)[0]));\r\n                let bCreationDate: Date = new Date(parseInt(b.split(this._backUpNameFormat)[0]));\r\n                if (aCreationDate < bCreationDate) {\r\n                    return -1;\r\n                }\r\n                if (aCreationDate >= bCreationDate) {\r\n                    return 1;\r\n                }\r\n            });\r\n            let totalFiles = files.length;\r\n            for (let i = 0; i < totalFiles - this.maxHistory; i++) {\r\n                let pathToDelete = path.join(this._tempDir, files[i]);\r\n                await FileSystemHelper.unlinkAsync(pathToDelete);\r\n            }\r\n        }\r\n        catch (err) {\r\n            console.log(this.TAG, \"Failed to cleanup log files: \" + (err && err.message));\r\n        }\r\n    }\r\n}\r\n\r\nexport = InternalAzureLogger;"]}