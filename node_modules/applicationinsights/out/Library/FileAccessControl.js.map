{"version":3,"file":"FileAccessControl.js","sourceRoot":"","sources":["../../Library/FileAccessControl.ts"],"names":[],"mappings":"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","sourcesContent":["import fs = require(\"fs\");\r\nimport os = require(\"os\");\r\nimport child_process = require(\"child_process\");\r\n\r\nimport Logging = require(\"./Logging\");\r\n\r\n\r\nexport class FileAccessControl {\r\n    private static TAG = \"FileAccessControl\";\r\n\r\n    private static ICACLS_PATH = `${process.env.systemdrive}/windows/system32/icacls.exe`;\r\n    private static POWERSHELL_PATH = `${process.env.systemdrive}/windows/system32/windowspowershell/v1.0/powershell.exe`;\r\n    private static ACLED_DIRECTORIES: { [id: string]: boolean } = {};\r\n    private static ACL_IDENTITY: string = null;\r\n    private static OS_FILE_PROTECTION_CHECKED = false;\r\n    public static OS_PROVIDES_FILE_PROTECTION = false;\r\n    public static USE_ICACLS = os.type() === \"Windows_NT\";\r\n\r\n\r\n    // Check if file access control could be enabled\r\n    public static checkFileProtection() {\r\n        if (!FileAccessControl.OS_PROVIDES_FILE_PROTECTION && !FileAccessControl.OS_FILE_PROTECTION_CHECKED) {\r\n            FileAccessControl.OS_FILE_PROTECTION_CHECKED = true;\r\n            // Node's chmod levels do not appropriately restrict file access on Windows\r\n            // Use the built-in command line tool ICACLS on Windows to properly restrict\r\n            // access to the temporary directory used for disk retry mode.\r\n            if (FileAccessControl.USE_ICACLS) {\r\n                // This should be async - but it's currently safer to have this synchronous\r\n                // This guarantees we can immediately fail setDiskRetryMode if we need to\r\n                try {\r\n                    FileAccessControl.OS_PROVIDES_FILE_PROTECTION = fs.existsSync(FileAccessControl.ICACLS_PATH);\r\n                } catch (e) { }\r\n                if (!FileAccessControl.OS_PROVIDES_FILE_PROTECTION) {\r\n                    Logging.warn(FileAccessControl.TAG, \"Could not find ICACLS in expected location! This is necessary to use disk retry mode on Windows.\")\r\n                }\r\n            } else {\r\n                // chmod works everywhere else\r\n                FileAccessControl.OS_PROVIDES_FILE_PROTECTION = true;\r\n            }\r\n        }\r\n    }\r\n\r\n    public static async applyACLRules(directory: string): Promise<void> {\r\n        if (FileAccessControl.USE_ICACLS) {\r\n            if (FileAccessControl.ACLED_DIRECTORIES[directory] === undefined) {\r\n                // Avoid multiple calls race condition by setting ACLED_DIRECTORIES to false for this directory immediately\r\n                // If batches are being failed faster than the processes spawned below return, some data won't be stored to disk\r\n                // This is better than the alternative of potentially infinitely spawned processes\r\n                FileAccessControl.ACLED_DIRECTORIES[directory] = false;\r\n                try {\r\n                    // Restrict this directory to only current user and administrator access\r\n                    let identity = await this._getACLIdentity();\r\n                    await this._runICACLS(this._getACLArguments(directory, identity));\r\n                    FileAccessControl.ACLED_DIRECTORIES[directory] = true;\r\n                }\r\n                catch (ex) {\r\n                    FileAccessControl.ACLED_DIRECTORIES[directory] = false; // false is used to cache failed (vs undefined which is \"not yet tried\")\r\n                    throw ex;\r\n                }\r\n            } else {\r\n                if (!FileAccessControl.ACLED_DIRECTORIES[directory]) {\r\n                    throw new Error(\"Setting ACL restrictions did not succeed (cached result)\");\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public static applyACLRulesSync(directory: string) {\r\n        if (FileAccessControl.USE_ICACLS) {\r\n            // For performance, only run ACL rules if we haven't already during this session\r\n            if (FileAccessControl.ACLED_DIRECTORIES[directory] === undefined) {\r\n                this._runICACLSSync(this._getACLArguments(directory, this._getACLIdentitySync()));\r\n                FileAccessControl.ACLED_DIRECTORIES[directory] = true; // If we get here, it succeeded. _runIACLSSync will throw on failures\r\n                return;\r\n            } else if (!FileAccessControl.ACLED_DIRECTORIES[directory]) { // falsy but not undefined\r\n                throw new Error(\"Setting ACL restrictions did not succeed (cached result)\");\r\n            }\r\n        }\r\n    }\r\n\r\n    private static _runICACLS(args: string[]): Promise<void> {\r\n        return new Promise((resolve, reject) => {\r\n            var aclProc = child_process.spawn(FileAccessControl.ICACLS_PATH, args, <any>{ windowsHide: true });\r\n            aclProc.on(\"error\", (e: Error) => reject(e));\r\n            aclProc.on(\"close\", (code: number, signal: string) => {\r\n                if (code === 0) {\r\n                    resolve();\r\n                }\r\n                else {\r\n                    reject(new Error(`Setting ACL restrictions did not succeed (ICACLS returned code ${code})`));\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    private static _runICACLSSync(args: string[]) {\r\n        // Some very old versions of Node (< 0.11) don't have this\r\n        if (child_process.spawnSync) {\r\n            var aclProc = child_process.spawnSync(FileAccessControl.ICACLS_PATH, args, <any>{ windowsHide: true });\r\n            if (aclProc.error) {\r\n                throw aclProc.error;\r\n            } else if (aclProc.status !== 0) {\r\n                throw new Error(`Setting ACL restrictions did not succeed (ICACLS returned code ${aclProc.status})`);\r\n            }\r\n        } else {\r\n            throw new Error(\"Could not synchronously call ICACLS under current version of Node.js\");\r\n        }\r\n    }\r\n\r\n    private static _getACLIdentity(): Promise<string> {\r\n        return new Promise((resolve, reject) => {\r\n            if (FileAccessControl.ACL_IDENTITY) {\r\n                resolve(FileAccessControl.ACL_IDENTITY);\r\n            }\r\n            var psProc = child_process.spawn(FileAccessControl.POWERSHELL_PATH,\r\n                [\"-Command\", \"[System.Security.Principal.WindowsIdentity]::GetCurrent().Name\"], <any>{\r\n                    windowsHide: true,\r\n                    stdio: ['ignore', 'pipe', 'pipe'] // Needed to prevent hanging on Win 7\r\n                });\r\n            let data = \"\";\r\n            psProc.stdout.on(\"data\", (d: string) => data += d);\r\n            psProc.on(\"error\", (e: Error) => reject(e));\r\n            psProc.on(\"close\", (code: number, signal: string) => {\r\n                FileAccessControl.ACL_IDENTITY = data && data.trim();\r\n                if (code === 0) {\r\n                    resolve(FileAccessControl.ACL_IDENTITY);\r\n                }\r\n                else {\r\n                    reject(new Error(`Getting ACL identity did not succeed (PS returned code ${code})`));\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    private static _getACLIdentitySync() {\r\n        if (FileAccessControl.ACL_IDENTITY) {\r\n            return FileAccessControl.ACL_IDENTITY;\r\n        }\r\n        // Some very old versions of Node (< 0.11) don't have this\r\n        if (child_process.spawnSync) {\r\n            var psProc = child_process.spawnSync(FileAccessControl.POWERSHELL_PATH,\r\n                [\"-Command\", \"[System.Security.Principal.WindowsIdentity]::GetCurrent().Name\"], <any>{\r\n                    windowsHide: true,\r\n                    stdio: ['ignore', 'pipe', 'pipe'] // Needed to prevent hanging on Win 7\r\n                });\r\n            if (psProc.error) {\r\n                throw psProc.error;\r\n            } else if (psProc.status !== 0) {\r\n                throw new Error(`Getting ACL identity did not succeed (PS returned code ${psProc.status})`);\r\n            }\r\n            FileAccessControl.ACL_IDENTITY = psProc.stdout && psProc.stdout.toString().trim();\r\n            return FileAccessControl.ACL_IDENTITY;\r\n        } else {\r\n            throw new Error(\"Could not synchronously get ACL identity under current version of Node.js\");\r\n        }\r\n    }\r\n\r\n    private static _getACLArguments(directory: string, identity: string) {\r\n        return [directory,\r\n            \"/grant\", \"*S-1-5-32-544:(OI)(CI)F\", // Full permission for Administrators\r\n            \"/grant\", `${identity}:(OI)(CI)F`, // Full permission for current user\r\n            \"/inheritance:r\"]; // Remove all inherited permissions\r\n    }\r\n}\r\n"]}