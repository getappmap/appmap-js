name: Build Native

on:
  pull_request:
  push:
    tags:
      - '@appland/appmap-v*'
      - '@appland/scanner-v*'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/') }}

jobs:
  setup:
    runs-on: ubuntu-slim
    timeout-minutes: 5
    if:
      ${{ contains(github.event.pull_request.labels.*.name, 'build native') ||
      startsWith(github.ref, 'refs/tags/@appland/') }}
    outputs:
      package_name: ${{ steps.determine.outputs.name }}
      package_dir: ${{ steps.determine.outputs.dir }}
    steps:
      - name: Determine package
        id: determine
        run: |
          ref="${{ github.ref }}"

          # Match scanner tags: @appland/scanner-v<digit>
          if [[ "$ref" =~ refs/tags/@appland/scanner-v[0-9] ]]; then
            echo "name=scanner" >> $GITHUB_OUTPUT
            echo "dir=packages/scanner" >> $GITHUB_OUTPUT
          # Match appmap tags: @appland/appmap-v<digit> (not appmap-<something>-v)
          elif [[ "$ref" =~ refs/tags/@appland/appmap-v[0-9] ]]; then
            echo "name=appmap" >> $GITHUB_OUTPUT
            echo "dir=packages/cli" >> $GITHUB_OUTPUT
          # For PR builds with label, default to appmap
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "name=appmap" >> $GITHUB_OUTPUT
            echo "dir=packages/cli" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Tag does not match expected pattern" >&2
            exit 1
          fi

  linux-x64:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PUPPETEER_SKIP_DOWNLOAD: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Build
        run: |
          yarn build
          cd ${{ needs.setup.outputs.package_dir }}
          yarn build-native linux x64

      - name: Publish artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ needs.setup.outputs.package_name }}-linux-x64
          path: ${{ needs.setup.outputs.package_dir }}/release/${{ needs.setup.outputs.package_name }}-linux-x64

  linux-arm64:
    needs: setup
    runs-on: linux-arm64
    timeout-minutes: 30
    env:
      PUPPETEER_SKIP_DOWNLOAD: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Build
        run: |
          yarn build
          cd ${{ needs.setup.outputs.package_dir }}
          yarn build-native linux arm64

      - name: Publish artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ needs.setup.outputs.package_name }}-linux-arm64
          path: ${{ needs.setup.outputs.package_dir }}/release/${{ needs.setup.outputs.package_name }}-linux-arm64

  macos-x64:
    needs: setup
    runs-on: macos-15-intel
    timeout-minutes: 60
    env:
      PUPPETEER_SKIP_DOWNLOAD: 1
      APPLE_IDENTITY_PRIVATE_KEY: ${{ secrets.APPLE_IDENTITY_PRIVATE_KEY }}
      APPLE_IDENTITY_CERTIFICATE: ${{ secrets.APPLE_IDENTITY_CERTIFICATE }}
      APPLE_CONNECT_KEY_B64: ${{ secrets.APPLE_CONNECT_KEY_B64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install deps
        run: |
          python3 -m pip install --break-system-packages setuptools

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Restore cargo cache
        uses: actions/cache@v5
        with:
          path: ~/.cargo
          key: ${{ runner.os }}-${{ runner.arch }}-cargo

      - name: Build binary
        run: |
          yarn build
          cd ${{ needs.setup.outputs.package_dir }}
          yarn build-native macos x64

      - name: Sign and notarize binary
        continue-on-error: ${{ github.ref_type != 'tag' }}
        run: |
          ${GITHUB_WORKSPACE}/bin/presign
          ${GITHUB_WORKSPACE}/bin/sign ${{ needs.setup.outputs.package_dir }}/release/${{ needs.setup.outputs.package_name }}-macos-x64
          ${GITHUB_WORKSPACE}/bin/notarize ${{ needs.setup.outputs.package_dir }}/release/${{ needs.setup.outputs.package_name }}-macos-x64

      - name: Publish artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ needs.setup.outputs.package_name }}-macos-x64
          path: ${{ needs.setup.outputs.package_dir }}/release/${{ needs.setup.outputs.package_name }}-macos-x64

  macos-arm64:
    needs: setup
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      PUPPETEER_SKIP_DOWNLOAD: 1
      APPLE_IDENTITY_PRIVATE_KEY: ${{ secrets.APPLE_IDENTITY_PRIVATE_KEY }}
      APPLE_IDENTITY_CERTIFICATE: ${{ secrets.APPLE_IDENTITY_CERTIFICATE }}
      APPLE_CONNECT_KEY_B64: ${{ secrets.APPLE_CONNECT_KEY_B64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install deps
        run: |
          python3 -m pip install --break-system-packages setuptools

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Restore cargo cache
        uses: actions/cache@v5
        with:
          path: ~/.cargo
          key: ${{ runner.os }}-${{ runner.arch }}-cargo

      - name: Build binary
        run: |
          yarn build
          cd ${{ needs.setup.outputs.package_dir }}
          yarn build-native macos arm64

      - name: Sign and notarize binary
        continue-on-error: ${{ github.ref_type != 'tag' }}
        run: |
          ${GITHUB_WORKSPACE}/bin/presign
          ${GITHUB_WORKSPACE}/bin/sign ${{ needs.setup.outputs.package_dir }}/release/${{ needs.setup.outputs.package_name }}-macos-arm64
          ${GITHUB_WORKSPACE}/bin/notarize ${{ needs.setup.outputs.package_dir }}/release/${{ needs.setup.outputs.package_name }}-macos-arm64

      - name: Publish artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ needs.setup.outputs.package_name }}-macos-arm64
          path: ${{ needs.setup.outputs.package_dir }}/release/${{ needs.setup.outputs.package_name }}-macos-arm64

  windows:
    needs: setup
    runs-on: windows-latest
    timeout-minutes: 30
    env:
      PUPPETEER_SKIP_DOWNLOAD: 1

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Restore cargo cache
        uses: actions/cache@v5
        with:
          path: ~/.cargo
          key: ${{ runner.os }}-${{ runner.arch }}-cargo

      - name: Build
        shell: bash
        run: |
          choco install rsync
          yarn build
          cd ${{ needs.setup.outputs.package_dir }}
          yarn build-native win x64

      - name: Sign the release with Trusted Signing
        uses: azure/trusted-signing-action@v0.3.16
        continue-on-error: ${{ github.ref_type != 'tag' }}
        with:
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          endpoint: https://eus.codesigning.azure.net/
          code-signing-account-name: appmap
          certificate-profile-name: appmap
          files-folder: ${{ github.workspace }}/${{ needs.setup.outputs.package_dir }}/release/
          files-folder-filter: exe,dll
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA256

      - name: Publish artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ needs.setup.outputs.package_name }}-win-x64
          path: ${{ needs.setup.outputs.package_dir }}/release/${{ needs.setup.outputs.package_name }}-win-x64.exe

  finalize-release:
    name: finalize release
    needs:
      - setup
      - linux-x64
      - linux-arm64
      - macos-x64
      - macos-arm64
      - windows
    if: github.ref_type == 'tag'
    runs-on: ubuntu-slim
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: Publish binaries to GitHub release
        run: gh release upload ${{ github.ref_name }} artifacts/* --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Release Manifests
        id: generate_manifest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p dist

          VERSION_TAG="${{ github.ref_name }}"
          BASE_TAG="${VERSION_TAG#@appland/}"
          TOOL_NAME="${BASE_TAG%%-v*}"

          echo "Fetching release data for $VERSION_TAG..."
          gh release view "$VERSION_TAG" --json tagName,assets > release.json

          echo "Generating manifest..."
          jq '{tag_name: .tagName, assets: [.assets[] | {name, url: .url, digest}]}' release.json > "dist/${BASE_TAG}.json"
          cp "dist/${BASE_TAG}.json" "dist/${TOOL_NAME}-latest.json"

          echo "Verifying checksums..."
          jq -r '.assets[] | .digest + "  " + .name' release.json > checksums.txt

          if grep -v '^sha256:' checksums.txt; then
            echo "::error::Invalid digest format found. Expected sha256:<hex>"
            exit 1
          fi

          cd artifacts
          cut -c8- ../checksums.txt | sha256sum --check

      - name: Publish GitHub Release
        run: gh release edit ${{ github.ref_name }} --draft=false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag npm package as latest
        run: yarn npm tag add `echo ${{ github.ref_name }} | sed -e s/-v/@/` latest
        env:
          YARN_NPM_AUTH_TOKEN: ${{ secrets.YARN_NPM_AUTH_TOKEN }}

      - name: Publish Manifests to release-manifests branch
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: release-manifests
          publish_dir: ./dist
          keep_files: true
          user_name: 'appland-release'
          user_email: 'release@app.land'
          commit_message: 'Update manifest for ${{ github.ref_name }}'
